import numpy as np
from sheerwater_benchmarking.metrics import summary_metrics_table, grouped_metric


def test_summary_metrics_table():
    """Tests the values of the summary metrics table"""
    start_time = "2016-01-01"
    end_time = "2022-12-31"
    grid = "global1_5"
    ds = summary_metrics_table(start_time, end_time, "precip", "era5", "mae",
                               grid=grid, region='africa', mask='lsm')
    ds = ds.fillna(-1)  # handle NaN values
    import pdb; pdb.set_trace()

    assert ds['week1'].to_list() == [6.424058138394581, 6.3054370804901305, 6.534232560218257,
                                     4.639284610748291, 3.9791030883789062, 3.602036444751744]
    assert ds['week2'].to_list() == [6.4243076388336755, 6.304762013166121, 6.5326217748731645,
                                     6.294214248657227, 5.24605131149292, 4.862046674791569]
    assert ds['week3'].to_list() == [6.425376506163869, 6.306151720821381, 6.533884923127238,
                                     6.852830410003662, 5.839285373687744, 5.411556285841169]
    assert ds['week4'].to_list() == [6.427669545396321, 6.307423059488268, 6.535748214840672,
                                     6.833979606628418, 6.025632381439209, 5.574113978556685]
    assert ds['week5'].to_list() == [6.424135309846871, 6.303272512649078, 6.531011452568051,
                                     6.8357319831848145, 6.1066155433654785, 5.641709112425802]
    assert ds['week6'].to_list() == [6.421606436870282, 6.299070488687551,
                                     6.529101696049089, 6.848753452301025, 6.151438236236572, -1]

    # Check temperature table
    ds = summary_metrics_table(start_time, end_time, "tmp2m", "era5", "mae",
                               grid=grid, region='africa', mask='lsm')
    ds = ds.fillna(-1)  # handle NaN values

    assert ds['week1'].to_list() == [1.2121512624816628, 1.1631965239378796, 1.1671185512966007,
                                     0.9678113460540771, 0.513611376285553, 0.41136738214090945]
    assert ds['week2'].to_list() == [1.2087075856111469, 1.1592590715955406, 1.1640229413481225,
                                     1.290499210357666, 0.7855541706085205, 0.7688365032677913]
    assert ds['week3'].to_list() == [1.2066457891812885, 1.1569646129408115, 1.1623737652775536,
                                     1.4039103984832764, 0.9737371802330017, 0.9663336167727571]
    assert ds['week4'].to_list() == [1.2061301185452484, 1.1562273151221267, 1.1611211202324103,
                                     1.4497779607772827, 1.0208297967910767, 1.0136641155001165]
    assert ds['week5'].to_list() == [1.2052313250488342, 1.1553134428619722, 1.1581391719404113,
                                     1.459323763847351, 1.044805645942688, 1.0272587271114906]
    assert ds['week6'].to_list() == [1.2049000933892866, 1.1547933823042746,
                                     1.1569957641109239, 1.4566011428833008, 1.0500701665878296, -1]


if __name__ == "__main__":
    test_summary_metrics_table()
    print("All tests passed")
